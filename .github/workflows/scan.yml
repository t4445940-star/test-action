name: test - Automated Scans

on:
  # Scheduled runs
  schedule:
    - cron: '30 * * * *'

  # Manual trigger
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Force restart (ignore resume state)'
        required: false
        type: boolean
        default: false
      scan_type_filter:
        description: 'Run specific scan type only (optional)'
        required: false
        type: string
        default: ''

# Allow concurrent runs
concurrency:
  group: scan-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  scan:
    name: Run Scans
    runs-on: ubuntu-latest
    timeout-minutes: 330

    steps:
      - name: Get device configuration from server
        id: get_config
        env:
          DJANGO_API_URL: ${{ secrets.DJANGO_API_URL }}
          AUTOMATION_TOKEN: ${{ secrets.AUTOMATION_TOKEN }}
          DEVICE_ID: ${{ secrets.DEVICE_ID }}
        run: |
          echo "üîç Fetching device configuration from server..."

          if [ -z "$DJANGO_API_URL" ] || [ -z "$AUTOMATION_TOKEN" ] || [ -z "$DEVICE_ID" ]; then
            echo "‚ùå ERROR: Missing required secrets!"
            echo "Please set DJANGO_API_URL, AUTOMATION_TOKEN, and DEVICE_ID"
            exit 1
          fi

          # Fetch device config from Django API
          RESPONSE=$(curl -s -X GET "$DJANGO_API_URL/scans/api/device-config/?device_id=$DEVICE_ID" \
            -H "Authorization: Token $AUTOMATION_TOKEN" \
            -H "Content-Type: application/json")

          echo "API Response: $RESPONSE"

          # Extract script_repo_url from response
          REPO_URL=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('script_repo_url', ''))")
          SCRIPT_PATH=$(echo "$RESPONSE" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data.get('script_path', 'bot.py'))")

          if [ -z "$REPO_URL" ] || [ "$REPO_URL" == "None" ]; then
            echo "‚ùå ERROR: No repository URL configured in device settings!"
            echo "Please add a script repository URL to your scan type or device configuration"
            exit 1
          fi

          echo "‚úÖ Configuration fetched from server"
          echo "Repository: $REPO_URL"
          echo "Script: $SCRIPT_PATH"

          # Export for next steps
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          echo "SCRIPT_PATH=$SCRIPT_PATH" >> $GITHUB_ENV

      - name: Clone scanner repository
        run: |
          echo "üì¶ Cloning scanner repository..."
          echo "Repository: $REPO_URL"

          git clone "$REPO_URL" scanner-repo
          cd scanner-repo
          echo "‚úÖ Repository cloned"
          echo ""
          echo "üìÇ Contents:"
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-test
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd scanner-repo
          python -m pip install --upgrade pip

          if [ -f requirements.txt ]; then
            echo "üì¶ Installing from requirements.txt..."
            pip install -r requirements.txt
          else
            echo "üì¶ Installing default packages..."
            pip install requests rich urllib3 dnspython
          fi

          echo ""
          echo "‚úÖ Packages installed:"
          pip list | head -20

      - name: Verify scanner script
        run: |
          cd scanner-repo
          echo "üîç Verifying script: $SCRIPT_PATH"

          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "‚ùå ERROR: $SCRIPT_PATH not found!"
            echo ""
            echo "Available files:"
            find . -name "*.py" -type f
            exit 1
          fi

          echo "‚úÖ Script found"

      - name: Run scanner
        env:
          DJANGO_API_URL: ${{ secrets.DJANGO_API_URL }}
          DJANGO_API_KEY: ${{ secrets.DJANGO_API_KEY }}
          AUTOMATION_TOKEN: ${{ secrets.AUTOMATION_TOKEN }}
          DEVICE_ID: ${{ secrets.DEVICE_ID }}
          # No group filter
          GITHUB_ACTIONS: 'true'
          CI: 'true'
          RUN_ID: ${{ github.run_id }}
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          cd scanner-repo

          echo "üöÄ Starting scanner..."
          echo "=========================================="
          echo "üìÖ Timestamp: $(date)"
          echo "üî¢ Run ID: ${{ github.run_id }}"
          echo "üî¢ Run Number: ${{ github.run_number }}"
          echo "‚öôÔ∏è  Device: test (ID: ${{ secrets.DEVICE_ID }})"

          echo "üîç Scans: All Scans"
          echo "=========================================="
          echo ""

          # Build command arguments
          SCAN_ARGS=""

          # Add force restart if specified
          if [ "${{ github.event.inputs.force_restart }}" == "true" ]; then
            SCAN_ARGS="$SCAN_ARGS --force-restart"
            echo "‚ö†Ô∏è  Force restart enabled"
          fi

          # Add scan type filter if specified
          if [ -n "${{ github.event.inputs.scan_type_filter }}" ]; then
            SCAN_ARGS="$SCAN_ARGS --scan-type ${{ github.event.inputs.scan_type_filter }}"
            echo "üéØ Scan type filter: ${{ github.event.inputs.scan_type_filter }}"
          fi

          echo ""
          echo "‚ñ∂Ô∏è  Command: python $SCRIPT_PATH $SCAN_ARGS"
          echo ""

          # Run scanner with timeout
          timeout 325m python $SCRIPT_PATH $SCAN_ARGS || exit_code=$?

          # Handle exit codes
          if [ ${exit_code:-0} -eq 0 ]; then
            echo ""
            echo "=========================================="
            echo "‚úÖ Scan completed successfully"
            echo "=========================================="
            exit 0
          elif [ ${exit_code:-0} -eq 124 ]; then
            echo ""
            echo "=========================================="
            echo "‚è∞ Scanner timed out"
            echo "‚úÖ Progress saved - will resume next run"
            echo "=========================================="
            exit 0
          else
            echo ""
            echo "=========================================="
            echo "‚ùå Scanner failed with exit code: ${exit_code:-0}"
            echo "=========================================="
            exit ${exit_code:-0}
          fi

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-logs-${{ github.run_id }}
          path: |
            scanner-repo/*.log
            scanner-repo/.scan_state/
          retention-days: 3
          if-no-files-found: ignore

      - name: Cleanup on failure
        if: failure()
        env:
          DJANGO_API_URL: ${{ secrets.DJANGO_API_URL }}
          AUTOMATION_TOKEN: ${{ secrets.AUTOMATION_TOKEN }}
          DEVICE_ID: ${{ secrets.DEVICE_ID }}
        run: |
          echo "üßπ Cleaning up after failure..."

          if [ -z "$DJANGO_API_URL" ] || [ -z "$AUTOMATION_TOKEN" ]; then
            echo "‚ö†Ô∏è  Cleanup skipped - credentials not configured"
            exit 0
          fi

          # Cleanup stale runs
          curl -X POST "${{ secrets.DJANGO_API_URL }}/api/automation/cleanup-stale/" \
            -H "Authorization: Token ${{ secrets.AUTOMATION_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"max_hours": 6}' \
            --silent --show-error || true

          # Reset device if needed
          if [ -n "$DEVICE_ID" ]; then
            curl -X POST "${{ secrets.DJANGO_API_URL }}/api/automation/device/force-reset/" \
              -H "Authorization: Token ${{ secrets.AUTOMATION_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"device_id\": ${{ secrets.DEVICE_ID }}}" \
              --silent --show-error || true
          fi

          echo "‚úÖ Cleanup completed"

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: scan
    if: always()

    steps:
      - name: Cleanup stale runs
        env:
          DJANGO_API_URL: ${{ secrets.DJANGO_API_URL }}
          AUTOMATION_TOKEN: ${{ secrets.AUTOMATION_TOKEN }}
        run: |
          echo "üßπ Running cleanup..."

          if [ -z "$DJANGO_API_URL" ] || [ -z "$AUTOMATION_TOKEN" ]; then
            echo "‚ö†Ô∏è  Skipped - credentials not configured"
            exit 0
          fi

          curl -X POST "${{ secrets.DJANGO_API_URL }}/api/automation/cleanup-stale/" \
            -H "Authorization: Token ${{ secrets.AUTOMATION_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"max_hours": 6}' \
            --silent --show-error || true

          echo "‚úÖ Cleanup completed"

  status:
    name: Report Status
    runs-on: ubuntu-latest
    needs: [scan, cleanup]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "üìä Workflow Status Report"
          echo "=========================================="
          echo "Device: test"
          echo "Scans: All Scans"

          echo "Run ID: ${{ github.run_id }}"
          echo "Timestamp: $(date)"
          echo "=========================================="
          echo ""
          echo "Job Results:"
          echo "  ‚Ä¢ Scan: ${{ needs.scan.result }}"
          echo "  ‚Ä¢ Cleanup: ${{ needs.cleanup.result }}"
          echo ""

          if [ "${{ needs.scan.result }}" == "success" ]; then
            echo "‚úÖ All scans completed successfully"
          elif [ "${{ needs.scan.result }}" == "failure" ]; then
            echo "‚ùå Scan job failed"
            echo ""
            echo "üîç Troubleshooting:"
            echo "  1. Check logs in Actions tab"
            echo "  2. Verify all secrets are set correctly"
            echo "  3. Ensure script exists: bot.py"
            echo "  4. Try manual run with force_restart: true"
          fi
